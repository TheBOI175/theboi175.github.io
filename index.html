<!DOCTYPE html>
<html>
<head>
    <title>Rip Chat</title>
</head>
<body>

    <!-- ==================== CENTERED CONTAINER ==================== -->
    <table width="100%" height="100%">
        <tr>
            <td align="center" valign="top">
                <br>

                <!-- ==================== LOBBY SECTION ==================== -->
                <div id="lobby">
                    <table width="400" cellpadding="10">
                        <tr>
                            <td align="center">
                                <h1>&#128483; Rip Chat</h1>
                                <p>Voice chat rooms for you and your friends</p>
                                <hr width="100%">
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Step 1: Enter Your Name</b></legend>
                                    <table width="100%">
                                        <tr>
                                            <td width="80">Username:</td>
                                            <td><input type="text" id="usernameInput" placeholder="Your name" maxlength="20" size="25"></td>
                                        </tr>
                                    </table>
                                    <small>Letters, numbers, spaces, dashes, underscores only</small>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Step 2: Create or Join</b></legend>
                                    <table width="100%" cellpadding="5">
                                        <tr>
                                            <td align="center">
                                                <p><b>Create New Room</b></p>
                                                <button id="createBtn" onclick="createRoom()">&#10010; Create Room</button>
                                                <br><br>
                                                <small>Get a code to share with friends</small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td align="center">
                                                <hr width="80%">
                                                <small>OR</small>
                                                <hr width="80%">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td align="center">
                                                <p><b>Join Existing Room</b></p>
                                                <input type="text" id="roomCodeInput" placeholder="ABC123" maxlength="6" size="10" 
                                                       onkeyup="this.value = this.value.toUpperCase()">
                                                <button id="joinBtn" onclick="joinRoom()">&#10148; Join</button>
                                                <br><br>
                                                <small>Enter the 6-letter room code</small>
                                            </td>
                                        </tr>
                                    </table>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td align="center">
                                <br>
                                <p id="lobbyStatus"><i>Connecting to server...</i></p>
                                <p id="lobbyError" hidden><font color="red"></font></p>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- ==================== ROOM SECTION ==================== -->
                <div id="room" hidden>
                    <table width="400" cellpadding="10">
                        <tr>
                            <td align="center">
                                <h1>&#128483; Rip Chat</h1>
                                <hr width="100%">
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Room Info</b></legend>
                                    <table width="100%" cellpadding="5">
                                        <tr>
                                            <td width="100">Room Code:</td>
                                            <td>
                                                <b><font size="+1"><span id="displayRoomCode">------</span></font></b>
                                                <button onclick="copyRoomCode()" title="Copy to clipboard">&#128203;</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Your Name:</td>
                                            <td><span id="displayUsername">------</span></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" align="center">
                                                <br>
                                                <button onclick="leaveRoom()">&#128682; Leave Room</button>
                                            </td>
                                        </tr>
                                    </table>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Users in Room (<span id="userCount">0</span>)</b></legend>
                                    <ul id="userList">
                                        <li><i>No users yet...</i></li>
                                    </ul>
                                    <hr>
                                    <small>&#128264; = Unmuted &nbsp; &#128263; = Muted</small>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Your Microphone</b></legend>
                                    <table width="100%">
                                        <tr>
                                            <td align="center">
                                                <button id="muteBtn" onclick="toggleMute()">&#128263; Mute</button>
                                                &nbsp;&nbsp;
                                                <span id="muteStatus">&#128264; <b>Unmuted</b></span>
                                            </td>
                                        </tr>
                                    </table>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td align="center">
                                <br>
                                <fieldset>
                                    <legend><b>Status</b></legend>
                                    <p id="roomStatus"><i>Connected</i></p>
                                    <small id="connectionIndicator">&#128994; Connected</small>
                                </fieldset>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Hidden audio elements -->
                <div id="audioContainer" hidden></div>

            </td>
        </tr>
    </table>

    <!-- ==================== SCRIPTS ==================== -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // ╔════════════════════════════════════════════════════════════╗
        // ║  CONFIGURATION - CHANGE THIS TO YOUR RENDER URL            ║
        // ╚════════════════════════════════════════════════════════════╝
        
        const SERVER_URL = 'https://rip-chat.onrender.com';
        
        // ════════════════════════════════════════════════════════════════

        const socket = io(SERVER_URL, {
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });

        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // ============ STATE ============
        let localStream = null;
        let peerConnections = {};
        let isMuted = false;
        let usersInRoom = {};
        let currentRoomCode = null;
        let currentUsername = null;
        let isConnected = false;
        let reconnectAttempt = 0;

        // ============ DOM ELEMENTS ============
        const lobbyDiv = document.getElementById('lobby');
        const roomDiv = document.getElementById('room');
        const lobbyStatus = document.getElementById('lobbyStatus');
        const lobbyError = document.getElementById('lobbyError');
        const roomStatus = document.getElementById('roomStatus');
        const userList = document.getElementById('userList');
        const audioContainer = document.getElementById('audioContainer');
        const connectionIndicator = document.getElementById('connectionIndicator');

        // ============ HELPERS ============
        
        function updateStatus(message, color = 'black') {
            roomStatus.innerHTML = `<font color="${color}">${message}</font>`;
        }

        function getTimestamp() {
            return new Date().toLocaleTimeString();
        }

        function showLobbyError(message) {
            lobbyError.innerHTML = `<font color="red">&#10008; ${message}</font>`;
            lobbyError.hidden = false;
            setTimeout(() => { lobbyError.hidden = true; }, 5000);
        }

        function setButtonsEnabled(enabled) {
            document.getElementById('createBtn').disabled = !enabled;
            document.getElementById('joinBtn').disabled = !enabled;
        }

        function updateConnectionIndicator(connected) {
            if (connected) {
                connectionIndicator.innerHTML = '&#128994; Connected';
            } else {
                connectionIndicator.innerHTML = '&#128308; Disconnected';
            }
        }

        function copyRoomCode() {
            const code = document.getElementById('displayRoomCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                updateStatus('&#10004; Room code copied!', 'green');
            }).catch(() => {
                updateStatus('&#10008; Could not copy code', 'red');
            });
        }

        // ============ SOCKET EVENT HANDLERS ============

        socket.on('connect', () => {
            isConnected = true;
            reconnectAttempt = 0;
            lobbyStatus.innerHTML = '<font color="green">&#10004; Connected to server. Ready!</font>';
            setButtonsEnabled(true);
            updateConnectionIndicator(true);
            
            // If we were in a room before disconnect, we can't auto-rejoin
            // because page refresh = new session. User must rejoin manually.
        });

        socket.on('disconnect', (reason) => {
            isConnected = false;
            updateConnectionIndicator(false);
            
            if (reason === 'io server disconnect') {
                lobbyStatus.innerHTML = '<font color="red">&#10008; Disconnected by server.</font>';
                updateStatus('&#10008; Disconnected by server.', 'red');
            } else {
                lobbyStatus.innerHTML = '<font color="orange">&#9888; Connection lost. Reconnecting...</font>';
                updateStatus('&#9888; Connection lost. Reconnecting...', 'orange');
            }
            
            setButtonsEnabled(false);
        });

        socket.on('connect_error', (error) => {
            reconnectAttempt++;
            lobbyStatus.innerHTML = `<font color="orange">&#9888; Connection failed (attempt ${reconnectAttempt}). Retrying...</font>`;
            setButtonsEnabled(false);
        });

        socket.on('reconnect', (attemptNumber) => {
            lobbyStatus.innerHTML = '<font color="green">&#10004; Reconnected!</font>';
            setButtonsEnabled(true);
            updateConnectionIndicator(true);
        });

        socket.on('error', (message) => {
            showLobbyError(message);
            updateStatus('&#10008; ' + message, 'red');
        });

        socket.on('room-created', async ({ roomCode, username }) => {
            currentRoomCode = roomCode;
            currentUsername = username;
            showRoom(roomCode, username);
            updateStatus('&#9203; Starting microphone...', 'blue');
            
            try {
                await startLocalAudio();
                userList.innerHTML = '';
                usersInRoom = {};
                usersInRoom[socket.id] = { username: username + ' (You)', muted: false };
                updateUserList();
                updateStatus('&#10004; Room created! Share code: <b>' + roomCode + '</b>', 'green');
            } catch (err) {
                updateStatus('&#10008; Microphone error: ' + err.message, 'red');
            }
        });

        socket.on('room-joined', async ({ roomCode, username, existingUsers }) => {
            currentRoomCode = roomCode;
            currentUsername = username;
            showRoom(roomCode, username);
            updateStatus('&#9203; Starting microphone...', 'blue');
            
            try {
                await startLocalAudio();
                
                userList.innerHTML = '';
                usersInRoom = {};
                usersInRoom[socket.id] = { username: username + ' (You)', muted: false };
                
                updateStatus('&#9203; Connecting to ' + existingUsers.length + ' user(s)...', 'blue');
                
                for (const user of existingUsers) {
                    usersInRoom[user.socketId] = { username: user.username, muted: user.muted || false };
                    await createPeerConnection(user.socketId, true);
                }
                
                updateUserList();
                updateStatus('&#10004; Joined room! Connected to ' + existingUsers.length + ' user(s)', 'green');
            } catch (err) {
                updateStatus('&#10008; Error: ' + err.message, 'red');
            }
        });

        socket.on('user-joined', async ({ username, socketId, muted }) => {
            usersInRoom[socketId] = { username, muted: muted || false };
            updateUserList();
            updateStatus('&#8594; <b>' + username + '</b> joined [' + getTimestamp() + ']', 'blue');
        });

        socket.on('user-left', ({ socketId, username }) => {
            delete usersInRoom[socketId];
            updateUserList();
            closePeerConnection(socketId);
            updateStatus('&#8592; <b>' + username + '</b> left [' + getTimestamp() + ']', 'orange');
        });

        socket.on('user-mute-changed', ({ socketId, muted }) => {
            if (usersInRoom[socketId]) {
                usersInRoom[socketId].muted = muted;
                updateUserList();
                const username = usersInRoom[socketId].username;
                if (socketId !== socket.id) {
                    if (muted) {
                        updateStatus('&#128263; <b>' + username + '</b> muted [' + getTimestamp() + ']', 'gray');
                    } else {
                        updateStatus('&#128264; <b>' + username + '</b> unmuted [' + getTimestamp() + ']', 'green');
                    }
                }
            }
        });

        socket.on('left-room', () => {
            // Confirmation that we left
        });

        socket.on('offer', async ({ offer, fromId, fromUsername }) => {
            updateStatus('&#9203; Connecting to <b>' + fromUsername + '</b>...', 'blue');
            try {
                await createPeerConnection(fromId, false);
                await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnections[fromId].createAnswer();
                await peerConnections[fromId].setLocalDescription(answer);
                socket.emit('answer', { targetId: fromId, answer });
            } catch (err) {
                console.error('Error handling offer:', err);
                updateStatus('&#10008; Connection error', 'red');
            }
        });

        socket.on('answer', async ({ answer, fromId }) => {
            if (peerConnections[fromId]) {
                try {
                    await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(answer));
                    updateStatus('&#10004; Voice connected!', 'green');
                } catch (err) {
                    console.error('Error handling answer:', err);
                }
            }
        });

        socket.on('ice-candidate', async ({ candidate, fromId }) => {
            if (peerConnections[fromId] && candidate) {
                try {
                    await peerConnections[fromId].addIceCandidate(new RTCIceCandidate(candidate));
                } catch (err) {
                    console.error('Error adding ICE candidate:', err);
                }
            }
        });

        socket.on('pong-server', ({ timestamp }) => {
            // Server is alive
            updateConnectionIndicator(true);
        });

        // ============ USER LIST ============

        function updateUserList() {
            userList.innerHTML = '';
            const userCount = Object.keys(usersInRoom).length;
            document.getElementById('userCount').textContent = userCount;
            
            for (const [socketId, user] of Object.entries(usersInRoom)) {
                const li = document.createElement('li');
                li.id = 'user-' + socketId;
                
                const muteIcon = user.muted ? '&#128263;' : '&#128264;';
                const muteColor = user.muted ? 'gray' : 'green';
                
                li.innerHTML = `<font color="${muteColor}">${muteIcon}</font> ${user.username}`;
                userList.appendChild(li);
            }
        }

        // ============ ROOM ACTIONS ============

        function createRoom() {
            if (!isConnected) {
                showLobbyError('Not connected to server. Please wait...');
                return;
            }
            
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                showLobbyError('Please enter your name first!');
                return;
            }
            
            if (username.length < 1) {
                showLobbyError('Username is too short!');
                return;
            }
            
            lobbyStatus.innerHTML = '<font color="blue">&#9203; Creating room...</font>';
            setButtonsEnabled(false);
            socket.emit('create-room', username);
            
            // Re-enable buttons after timeout in case of no response
            setTimeout(() => setButtonsEnabled(true), 5000);
        }

        function joinRoom() {
            if (!isConnected) {
                showLobbyError('Not connected to server. Please wait...');
                return;
            }
            
            const username = document.getElementById('usernameInput').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!username) {
                showLobbyError('Please enter your name first!');
                return;
            }
            
            if (!roomCode) {
                showLobbyError('Please enter a room code!');
                return;
            }
            
            if (roomCode.length !== 6) {
                showLobbyError('Room code must be 6 characters!');
                return;
            }
            
            lobbyStatus.innerHTML = '<font color="blue">&#9203; Joining room...</font>';
            setButtonsEnabled(false);
            socket.emit('join-room', { roomCode, username });
            
            // Re-enable buttons after timeout in case of no response
            setTimeout(() => setButtonsEnabled(true), 5000);
        }

        function leaveRoom() {
            socket.emit('leave-room');
            
            // Cleanup
            for (const id in peerConnections) {
                closePeerConnection(id);
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            usersInRoom = {};
            currentRoomCode = null;
            currentUsername = null;
            userList.innerHTML = '<li><i>No users yet...</i></li>';
            audioContainer.innerHTML = '';
            isMuted = false;
            document.getElementById('muteBtn').innerHTML = '&#128263; Mute';
            document.getElementById('muteStatus').innerHTML = '&#128264; <b>Unmuted</b>';

            roomDiv.hidden = true;
            lobbyDiv.hidden = false;
            lobbyStatus.innerHTML = '<font color="green">&#10004; Left room. Ready to join another!</font>';
            setButtonsEnabled(true);
        }

        function showRoom(roomCode, username) {
            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('displayUsername').textContent = username;
            lobbyDiv.hidden = true;
            roomDiv.hidden = false;
        }

        // ============ AUDIO FUNCTIONS ============

        async function startLocalAudio() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }, 
                    video: false 
                });
            } catch (err) {
                console.error('Microphone error:', err);
                throw err;
            }
        }

        function toggleMute() {
            if (!localStream) return;
            
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            // Update UI
            document.getElementById('muteBtn').innerHTML = isMuted ? '&#128264; Unmute' : '&#128263; Mute';
            document.getElementById('muteStatus').innerHTML = isMuted 
                ? '<font color="red">&#128263; <b>Muted</b></font>' 
                : '&#128264; <b>Unmuted</b>';
            
            // Update local user in list
            if (usersInRoom[socket.id]) {
                usersInRoom[socket.id].muted = isMuted;
                updateUserList();
            }
            
            // Tell server about mute status
            socket.emit('mute-status', { muted: isMuted });
            
            updateStatus(isMuted ? '&#128263; You muted yourself' : '&#128264; You unmuted yourself', isMuted ? 'gray' : 'green');
        }

        // ============ WEBRTC FUNCTIONS ============

        async function createPeerConnection(targetId, isInitiator) {
            // Close existing connection if any
            if (peerConnections[targetId]) {
                peerConnections[targetId].close();
            }
            
            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[targetId] = pc;

            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { 
                        targetId, 
                        candidate: event.candidate 
                    });
                }
            };

            pc.ontrack = (event) => {
                createAudioElement(targetId, event.streams[0]);
            };

            pc.onconnectionstatechange = () => {
                const state = pc.connectionState;
                console.log(`Connection to ${targetId}: ${state}`);
                
                if (state === 'connected') {
                    updateStatus('&#10004; Voice connected!', 'green');
                } else if (state === 'disconnected') {
                    updateStatus('&#9888; Voice connection interrupted', 'orange');
                } else if (state === 'failed') {
                    updateStatus('&#10008; Voice connection failed', 'red');
                    // Try to reconnect
                    closePeerConnection(targetId);
                }
            };

            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'failed') {
                    pc.restartIce();
                }
            };

            if (isInitiator) {
                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    socket.emit('offer', { targetId, offer });
                } catch (err) {
                    console.error('Error creating offer:', err);
                }
            }

            return pc;
        }

        function closePeerConnection(targetId) {
            if (peerConnections[targetId]) {
                peerConnections[targetId].close();
                delete peerConnections[targetId];
            }
            removeAudioElement(targetId);
        }

        // ============ AUDIO ELEMENTS ============

        function createAudioElement(peerId, stream) {
            removeAudioElement(peerId);
            const audio = document.createElement('audio');
            audio.id = 'audio-' + peerId;
            audio.srcObject = stream;
            audio.autoplay = true;
            audioContainer.appendChild(audio);
        }

        function removeAudioElement(peerId) {
            const audio = document.getElementById('audio-' + peerId);
            if (audio) audio.remove();
        }

        // ============ PERIODIC HEALTH CHECK ============

        setInterval(() => {
            if (isConnected && currentRoomCode) {
                socket.emit('ping-server');
            }
        }, 30000);

        // ============ HANDLE PAGE VISIBILITY ============

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && currentRoomCode) {
                // Page became visible again, check connection
                socket.emit('ping-server');
            }
        });

        // ============ ENTER KEY HANDLERS ============

        document.getElementById('usernameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('roomCodeInput').focus();
            }
        });

        document.getElementById('roomCodeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinRoom();
            }
        });
    </script>

</body>
</html>
