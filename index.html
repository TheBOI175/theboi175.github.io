<!DOCTYPE html>
<html>
<head>
    <title>Google Slides</title>
</head>
<body>

    <!-- ==================== CENTERED CONTAINER ==================== -->
    <table width="100%" height="100%">
        <tr>
            <td align="center" valign="top">
                <br>

                <!-- ==================== LOBBY SECTION ==================== -->
                <div id="lobby">
                    <table width="400" cellpadding="10">
                        <tr>
                            <td align="center">
                                <h1>Rip Chat</h1>
                                <p>Voice chat rooms for you and your friends</p>
                                <hr width="100%">
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Step 1: Enter Your Name</b></legend>
                                    <table width="100%">
                                        <tr>
                                            <td width="80">Username:</td>
                                            <td><input type="text" id="usernameInput" placeholder="Your name" maxlength="20" size="25"></td>
                                        </tr>
                                    </table>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Step 2: Create or Join</b></legend>
                                    <table width="100%" cellpadding="5">
                                        <tr>
                                            <td align="center">
                                                <p><b>Create New Room</b></p>
                                                <button onclick="createRoom()">&#10010; Create Room</button>
                                                <br><br>
                                                <small>Get a code to share with friends</small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td align="center">
                                                <hr width="80%">
                                                <small>OR</small>
                                                <hr width="80%">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td align="center">
                                                <p><b>Join Existing Room</b></p>
                                                <input type="text" id="roomCodeInput" placeholder="ABC123" maxlength="6" size="10">
                                                <button onclick="joinRoom()">&#10148; Join</button>
                                                <br><br>
                                                <small>Enter the 6-letter room code</small>
                                            </td>
                                        </tr>
                                    </table>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td align="center">
                                <br>
                                <p id="lobbyStatus"><i>Connecting to server...</i></p>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- ==================== ROOM SECTION ==================== -->
                <div id="room" hidden>
                    <table width="400" cellpadding="10">
                        <tr>
                            <td align="center">
                                <h1>&#128483; Rip Chat</h1>
                                <hr width="100%">
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Room Info</b></legend>
                                    <table width="100%" cellpadding="5">
                                        <tr>
                                            <td width="100">Room Code:</td>
                                            <td><b><font size="+1"><span id="displayRoomCode">------</span></font></b></td>
                                        </tr>
                                        <tr>
                                            <td>Your Name:</td>
                                            <td><span id="displayUsername">------</span></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" align="center">
                                                <br>
                                                <button onclick="leaveRoom()">&#128682; Leave Room</button>
                                            </td>
                                        </tr>
                                    </table>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Users in Room</b></legend>
                                    <ul id="userList">
                                        <li><i>No users yet...</i></li>
                                    </ul>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <fieldset>
                                    <legend><b>Audio Controls</b></legend>
                                    <table width="100%">
                                        <tr>
                                            <td align="center">
                                                <button id="muteBtn" onclick="toggleMute()">&#128263; Mute</button>
                                                &nbsp;&nbsp;
                                                <span id="muteStatus">&#128264; Unmuted</span>
                                            </td>
                                        </tr>
                                    </table>
                                </fieldset>
                            </td>
                        </tr>

                        <tr>
                            <td align="center">
                                <br>
                                <p id="roomStatus"><i>Connected</i></p>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Hidden audio elements -->
                <div id="audioContainer" hidden></div>

            </td>
        </tr>
    </table>

    <!-- ==================== SCRIPTS ==================== -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // ╔════════════════════════════════════════════════════════════╗
        // ║  CONFIGURATION - CHANGE THIS TO YOUR RENDER URL            ║
        // ╚════════════════════════════════════════════════════════════╝
        
        const SERVER_URL = 'https://rip-chat.onrender.com';
        
        // ════════════════════════════════════════════════════════════════

        const socket = io(SERVER_URL);

        // WebRTC configuration
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // ============ STATE ============
        let localStream = null;
        let peerConnections = {};
        let isMuted = false;

        // ============ DOM ELEMENTS ============
        const lobbyDiv = document.getElementById('lobby');
        const roomDiv = document.getElementById('room');
        const lobbyStatus = document.getElementById('lobbyStatus');
        const roomStatus = document.getElementById('roomStatus');
        const userList = document.getElementById('userList');
        const audioContainer = document.getElementById('audioContainer');

        // ============ SOCKET EVENT HANDLERS ============

        socket.on('connect', () => {
            lobbyStatus.innerHTML = '<font color="green">&#10004; Connected to server. Ready!</font>';
        });

        socket.on('disconnect', () => {
            lobbyStatus.innerHTML = '<font color="red">&#10008; Disconnected from server.</font>';
            roomStatus.innerHTML = '<font color="red">&#10008; Lost connection to server.</font>';
        });

        socket.on('error', (message) => {
            alert('Error: ' + message);
        });

        socket.on('room-created', async ({ roomCode, username }) => {
            showRoom(roomCode, username);
            await startLocalAudio();
            userList.innerHTML = '';
            addUserToList(socket.id, username + ' (You)');
            roomStatus.innerHTML = '<font color="green">&#10004; Room created. Share the code!</font>';
        });

        socket.on('room-joined', async ({ roomCode, username, existingUsers }) => {
            showRoom(roomCode, username);
            await startLocalAudio();
            userList.innerHTML = '';
            addUserToList(socket.id, username + ' (You)');

            for (const user of existingUsers) {
                addUserToList(user.socketId, user.username);
                await createPeerConnection(user.socketId, true);
            }
            roomStatus.innerHTML = '<font color="green">&#10004; Joined room!</font>';
        });

        socket.on('user-joined', async ({ username, socketId }) => {
            addUserToList(socketId, username);
            roomStatus.innerHTML = '<font color="blue">&#8594; ' + username + ' joined</font>';
        });

        socket.on('user-left', ({ socketId, username }) => {
            removeUserFromList(socketId);
            closePeerConnection(socketId);
            roomStatus.innerHTML = '<font color="orange">&#8592; ' + username + ' left</font>';
        });

        socket.on('offer', async ({ offer, fromId, fromUsername }) => {
            await createPeerConnection(fromId, false);
            await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnections[fromId].createAnswer();
            await peerConnections[fromId].setLocalDescription(answer);
            socket.emit('answer', { targetId: fromId, answer });
        });

        socket.on('answer', async ({ answer, fromId }) => {
            if (peerConnections[fromId]) {
                await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(answer));
            }
        });

        socket.on('ice-candidate', async ({ candidate, fromId }) => {
            if (peerConnections[fromId] && candidate) {
                await peerConnections[fromId].addIceCandidate(new RTCIceCandidate(candidate));
            }
        });

        // ============ ROOM ACTIONS ============

        function createRoom() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Please enter your name first!');
                return;
            }
            socket.emit('create-room', username);
        }

        function joinRoom() {
            const username = document.getElementById('usernameInput').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!username) {
                alert('Please enter your name first!');
                return;
            }
            if (!roomCode) {
                alert('Please enter a room code!');
                return;
            }
            socket.emit('join-room', { roomCode, username });
        }

        function leaveRoom() {
            socket.emit('leave-room');
            
            for (const id in peerConnections) {
                closePeerConnection(id);
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            userList.innerHTML = '<li><i>No users yet...</i></li>';
            audioContainer.innerHTML = '';

            roomDiv.hidden = true;
            lobbyDiv.hidden = false;
            lobbyStatus.innerHTML = '<font color="green">&#10004; Left room. Ready to join another!</font>';
        }

        function showRoom(roomCode, username) {
            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('displayUsername').textContent = username;
            lobbyDiv.hidden = true;
            roomDiv.hidden = false;
        }

        // ============ AUDIO FUNCTIONS ============

        async function startLocalAudio() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: false 
                });
            } catch (err) {
                alert('Could not access microphone: ' + err.message);
                throw err;
            }
        }

        function toggleMute() {
            if (!localStream) return;
            
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            document.getElementById('muteBtn').innerHTML = isMuted ? '&#128264; Unmute' : '&#128263; Mute';
            document.getElementById('muteStatus').innerHTML = isMuted 
                ? '<font color="red">&#128263; Muted</font>' 
                : '&#128264; Unmuted';
        }

        // ============ WEBRTC FUNCTIONS ============

        async function createPeerConnection(targetId, isInitiator) {
            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[targetId] = pc;

            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { 
                        targetId, 
                        candidate: event.candidate 
                    });
                }
            };

            pc.ontrack = (event) => {
                createAudioElement(targetId, event.streams[0]);
            };

            pc.onconnectionstatechange = () => {
                console.log(`Connection to ${targetId}: ${pc.connectionState}`);
            };

            if (isInitiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('offer', { targetId, offer });
            }

            return pc;
        }

        function closePeerConnection(targetId) {
            if (peerConnections[targetId]) {
                peerConnections[targetId].close();
                delete peerConnections[targetId];
            }
            removeAudioElement(targetId);
        }

        // ============ UI HELPERS ============

        function addUserToList(socketId, username) {
            const li = document.createElement('li');
            li.id = 'user-' + socketId;
            li.textContent = username;
            userList.appendChild(li);
        }

        function removeUserFromList(socketId) {
            const li = document.getElementById('user-' + socketId);
            if (li) li.remove();
        }

        function createAudioElement(peerId, stream) {
            removeAudioElement(peerId);
            const audio = document.createElement('audio');
            audio.id = 'audio-' + peerId;
            audio.srcObject = stream;
            audio.autoplay = true;
            audioContainer.appendChild(audio);
        }

        function removeAudioElement(peerId) {
            const audio = document.getElementById('audio-' + peerId);
            if (audio) audio.remove();
        }
    </script>

</body>
</html>
